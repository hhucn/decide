image: clojure:openjdk-11-tools-deps

services:
  - docker:stable-dind

cache:
  key: ${CI_JOB_NAME}
  paths:
    - node_modules/
    - .m2

stages:
  - build
  - test
  - build-images
  - analysis
  - deploy

cljs-test:
  image: circleci/clojure:openjdk-11-tools-deps-node-browsers
  stage: test
  before_script:
    - npm install
  script:
    - npx shadow-cljs compile ci-tests
    - npx karma start --single-run
  allow_failure: true # While the jar of hasch is broken

clj-test:
  stage: test
  script:
    - clojure -Sdeps '{:mvn/local-repo ".m2"}' -A:dev:clj-tests

include:
  template: Dependency-Scanning.gitlab-ci.yml